generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Part {
  id                 String                    @id @default(cuid())
  partNo             String                    @unique
  masterPartNo       String?
  brand              String?
  description        String?
  mainCategory       String?
  subCategory        String?
  application        String?
  hsCode             String?
  uom                String?
  weight             Float?
  reOrderLevel       Int                       @default(0)
  cost               Float?
  priceA             Float?
  priceB             Float?
  priceM             Float?
  rackNo             String?
  origin             String?
  grade              String?
  status             String                    @default("A")
  smc                String?
  size               String?
  remarks            String?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  imageUrl1          String?
  imageUrl2          String?
  adjustmentItems    InventoryAdjustmentItem[]
  kitItems           KitItem[]
  models             PartModel[]
  purchaseOrderItems PurchaseOrderItem[]
  salesInvoiceItems  SalesInvoiceItem[]
  stock              Stock?
}

model PartModel {
  id        String   @id @default(cuid())
  partId    String
  modelNo   String
  qtyUsed   Int
  tab       String   @default("P1")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  part      Part     @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
}

model Stock {
  id        String   @id @default(cuid())
  partId    String   @unique
  quantity  Int      @default(0)
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  racks     String?
  shelf     String?
  store     String?
  part      Part     @relation(fields: [partId], references: [id], onDelete: Cascade)
}

model Category {
  id            String     @id @default(cuid())
  name          String
  type          String
  parentId      String?
  description   String?
  status        String     @default("A")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  parent        Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  subcategories Category[] @relation("CategoryHierarchy")

  @@index([type])
  @@index([parentId])
}

// New models for Parts Management System
model StoreType {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stores    Store[]

  @@index([name])
}

model Store {
  id              String          @id @default(cuid())
  name            String
  storeTypeId     String
  description     String?
  status          String          @default("A")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  storeType       StoreType       @relation(fields: [storeTypeId], references: [id], onDelete: Cascade)
  racks           Rack[]
  itemInventories ItemInventory[]

  @@index([name])
  @@index([storeTypeId])
}

model Rack {
  id              String          @id @default(cuid())
  rackNumber      String
  storeId         String
  description     String?
  status          String          @default("A")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  store           Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  shelves         Shelf[]
  itemInventories ItemInventory[]

  @@unique([rackNumber, storeId])
  @@index([storeId])
}

model Shelf {
  id              String          @id @default(cuid())
  shelfNumber     String
  rackId          String
  description     String?
  status          String          @default("A")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  rack            Rack            @relation(fields: [rackId], references: [id], onDelete: Cascade)
  itemInventories ItemInventory[]

  @@unique([shelfNumber, rackId])
  @@index([rackId])
}

model Brand {
  id        String   @id @default(cuid())
  name      String   @unique
  status    String   @default("A") // "A" for active, "I" for inactive
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  items     Item[]

  @@index([name])
  @@index([status])
}

model Unit {
  id           String        @id @default(cuid())
  name         String        @unique
  shortName    String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  machineParts MachinePart[]

  @@index([name])
}

model MachineModel {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  items     Item[]

  @@index([name])
}

model MachinePart {
  id                  String               @id @default(cuid())
  name                String               @unique
  unitId              String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  unit                Unit                 @relation(fields: [unitId], references: [id])
  machinePartOemParts MachinePartOemPart[]
  kitchilds           KitChild[]

  @@index([name])
  @@index([unitId])
}

model OemPartNumber {
  id                  String               @id @default(cuid())
  number1             String
  number2             String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  machinePartOemParts MachinePartOemPart[]

  @@unique([number1, number2])
  @@index([number1])
}

model MachinePartOemPart {
  id              String        @id @default(cuid())
  machinePartId   String
  oemPartNumberId String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  machinePart     MachinePart   @relation(fields: [machinePartId], references: [id], onDelete: Cascade)
  oemPartNumber   OemPartNumber @relation(fields: [oemPartNumberId], references: [id], onDelete: Cascade)
  items           Item[]

  @@unique([machinePartId, oemPartNumberId])
  @@index([machinePartId])
  @@index([oemPartNumberId])
}

model Item {
  id                   String             @id @default(cuid())
  machinePartOemPartId String
  brandId              String
  machineModelId       String
  typeId               Int                @default(1) // 1 = parts, 2 = kits
  status               String             @default("A")
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  machinePartOemPart   MachinePartOemPart @relation(fields: [machinePartOemPartId], references: [id], onDelete: Cascade)
  brand                Brand              @relation(fields: [brandId], references: [id])
  machineModel         MachineModel       @relation(fields: [machineModelId], references: [id])
  inventories          ItemInventory[]
  kitItems             KitChild[]         @relation("KitChild_Kit")
  childItems           KitChild[]         @relation("KitChild_Child")

  @@index([machinePartOemPartId])
  @@index([brandId])
  @@index([machineModelId])
  @@index([typeId])
}

// Updated inventory model to support multiple rack-shelf assignments
model ItemInventory {
  id        String   @id @default(cuid())
  itemId    String
  storeId   String
  rackId    String
  shelfId   String
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  store     Store    @relation(fields: [storeId], references: [id])
  rack      Rack     @relation(fields: [rackId], references: [id])
  shelf     Shelf    @relation(fields: [shelfId], references: [id])

  @@unique([itemId, storeId, rackId, shelfId])
  @@index([itemId])
  @@index([storeId])
  @@index([rackId])
  @@index([shelfId])
}

// Updated Kit models to work with new Item structure
model KitChild {
  id            String       @id @default(cuid())
  kitItemId     String
  childItemId   String
  machinePartId String?
  quantity      Int          @default(1)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  kitItem       Item         @relation("KitChild_Kit", fields: [kitItemId], references: [id], onDelete: Cascade)
  childItem     Item         @relation("KitChild_Child", fields: [childItemId], references: [id], onDelete: Cascade)
  machinePart   MachinePart? @relation(fields: [machinePartId], references: [id], onDelete: SetNull)

  @@unique([kitItemId, childItemId])
  @@index([kitItemId])
  @@index([childItemId])
}

// Inventory flow tracking for kit operations
model InventoryFlow {
  id        String   @id @default(cuid())
  itemId    String
  storeId   String
  inFlow    Int      @default(0)
  outFlow   Int      @default(0)
  reason    String? // "make_kit", "break_kit", "adjustment", etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([itemId])
  @@index([storeId])
  @@index([createdAt])
}

model Kit {
  id          String    @id @default(cuid())
  kitNo       String    @unique
  name        String
  description String?
  totalCost   Float     @default(0)
  price       Float?
  status      String    @default("A")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  items       KitItem[]

  @@index([kitNo])
}

model KitItem {
  id        String   @id @default(cuid())
  kitId     String
  partId    String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  part      Part     @relation(fields: [partId], references: [id], onDelete: Cascade)
  kit       Kit      @relation(fields: [kitId], references: [id], onDelete: Cascade)

  @@index([kitId])
  @@index([partId])
}

model Supplier {
  id             String          @id @default(cuid())
  code           String          @unique
  name           String
  email          String?
  phone          String?
  address        String?
  city           String?
  state          String?
  country        String?
  zipCode        String?
  contactPerson  String?
  taxId          String?
  paymentTerms   String?
  notes          String?
  status         String          @default("A")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]

  @@index([code])
  @@index([status])
}

model Customer {
  id             String         @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  cnic           String?
  status         String         @default("A")
  openingBalance Float          @default(0)
  creditBalance  Float          @default(0)
  creditLimit    Float          @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  salesInvoices  SalesInvoice[]

  @@index([name])
  @@index([status])
  @@index([phone])
}

model PurchaseOrder {
  id              String              @id @default(cuid())
  poNo            String              @unique
  type            String
  supplierId      String?
  supplierName    String
  supplierEmail   String?
  supplierPhone   String?
  supplierAddress String?
  orderDate       DateTime            @default(now())
  expectedDate    DateTime?
  status          String              @default("draft")
  paymentMethod   String? // cash, bank_transfer, cheque, credit_card, other
  subTotal        Float               @default(0)
  tax             Float               @default(0)
  discount        Float               @default(0)
  totalAmount     Float               @default(0)
  notes           String?
  createdBy       String?
  approvedBy      String?
  approvedAt      DateTime?
  receivedAt      DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  supplier        Supplier?           @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  items           PurchaseOrderItem[]
  vouchers        Voucher[]           @relation("PurchaseOrderVouchers")

  @@index([poNo])
  @@index([status])
  @@index([type])
  @@index([orderDate])
  @@index([supplierId])
}

model SalesInvoice {
  id              String             @id @default(cuid())
  invoiceNo       String             @unique
  quotationId     String?
  customerId      String?
  customerName    String
  customerEmail   String?
  customerPhone   String?
  customerAddress String?
  invoiceDate     DateTime           @default(now())
  dueDate         DateTime
  status          String             @default("draft")
  subTotal        Float              @default(0)
  tax             Float              @default(0)
  discount        Float              @default(0)
  totalAmount     Float              @default(0)
  paidAmount      Float              @default(0)
  balanceAmount   Float              @default(0)
  notes           String?
  createdBy       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  customer        Customer?          @relation(fields: [customerId], references: [id])
  items           SalesInvoiceItem[]

  @@index([invoiceNo])
  @@index([status])
  @@index([invoiceDate])
  @@index([customerName])
  @@index([customerId])
}

model SalesInvoiceItem {
  id             String       @id @default(cuid())
  salesInvoiceId String
  partId         String?
  partNo         String
  description    String?
  quantity       Int          @default(1)
  unitPrice      Float
  totalPrice     Float
  uom            String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  part           Part?        @relation(fields: [partId], references: [id], onDelete: SetNull)
  salesInvoice   SalesInvoice @relation(fields: [salesInvoiceId], references: [id], onDelete: Cascade)

  @@index([salesInvoiceId])
  @@index([partId])
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  partId          String?
  partNo          String
  description     String?
  quantity        Int
  unitPrice       Float
  totalPrice      Float
  uom             String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  part            Part?         @relation(fields: [partId], references: [id], onDelete: SetNull)
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([partId])
}

model Vehicle {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model VehicleModel {
  id        String   @id @default(cuid())
  machine   String
  make      String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([machine])
  @@index([make])
  @@index([name])
}

model Make {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model InventoryAdjustment {
  id           String                    @id @default(cuid())
  adjustmentNo String?
  total        Float                     @default(0)
  date         DateTime                  @default(now())
  notes        String?
  createdBy    String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  items        InventoryAdjustmentItem[]

  @@index([date])
  @@index([adjustmentNo])
}

model InventoryAdjustmentItem {
  id               String              @id @default(cuid())
  adjustmentId     String
  partId           String?
  partNo           String
  description      String?
  previousQuantity Int                 @default(0)
  adjustedQuantity Int
  newQuantity      Int
  reason           String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  part             Part?               @relation(fields: [partId], references: [id])
  adjustment       InventoryAdjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)

  @@index([adjustmentId])
  @@index([partId])
}

model Application {
  id        String   @id @default(cuid())
  name      String   @unique
  status    String   @default("A") // "A" for active, "I" for inactive
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([status])
}

// Accounts Management Models (Legacy - keeping for backward compatibility)
model MainGroup {
  id        String     @id @default(cuid())
  code      Int        @unique
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  subGroups SubGroup[]

  @@index([code])
  @@index([name])
}

model SubGroup {
  id          String    @id @default(cuid())
  mainGroupId String
  code        String
  name        String
  status      String    @default("Active")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  mainGroup   MainGroup @relation(fields: [mainGroupId], references: [id], onDelete: Cascade)
  accounts    Account[]

  @@unique([code, mainGroupId])
  @@index([mainGroupId])
  @@index([code])
  @@index([name])
}

model Account {
  id         String   @id @default(cuid())
  subGroupId String
  code       String   @unique
  name       String
  status     String   @default("Active")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  subGroup   SubGroup @relation(fields: [subGroupId], references: [id], onDelete: Cascade)

  @@index([subGroupId])
  @@index([code])
  @@index([name])
  @@index([status])
}

// Chart of Accounts (COA) Models - Complete Accounting System
model CoaGroup {
  id        Int           @id @default(autoincrement())
  name      String
  code      String
  parent    String // Assets, Liabilities, Capital, Revenues, Expenses, Cost
  userId    String?       @map("user_id")
  isActive  Boolean       @default(true) @map("is_active")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  subGroups CoaSubGroup[]
  accounts  CoaAccount[]

  @@index([userId])
  @@index([parent])
  @@map("coa_groups")
}

model CoaSubGroup {
  id         Int          @id @default(autoincrement())
  coaGroupId Int          @map("coa_group_id")
  name       String
  code       String
  type       String? // cash, bank, inventory, etc.
  userId     String?      @map("user_id")
  isActive   Boolean      @default(true) @map("is_active")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")
  coaGroup   CoaGroup     @relation(fields: [coaGroupId], references: [id], onDelete: Cascade)
  accounts   CoaAccount[]

  @@index([coaGroupId])
  @@index([userId])
  @@index([type])
  @@map("coa_sub_groups")
}

model CoaAccount {
  id            Int                  @id @default(autoincrement())
  name          String
  code          String
  userId        String?              @map("user_id")
  coaGroupId    Int                  @map("coa_group_id")
  coaSubGroupId Int                  @map("coa_sub_group_id")
  personId      String?              @map("person_id")
  description   String?
  type          String? // mouza, etc.
  isActive      Boolean              @default(true) @map("is_active")
  isDefault     Boolean              @default(false) @map("is_default")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  coaGroup      CoaGroup             @relation(fields: [coaGroupId], references: [id], onDelete: Cascade)
  coaSubGroup   CoaSubGroup          @relation(fields: [coaSubGroupId], references: [id], onDelete: Cascade)
  transactions  VoucherTransaction[]

  @@index([userId])
  @@index([coaSubGroupId])
  @@index([coaGroupId])
  @@index([code])
  @@map("coa_accounts")
}

// Person model for person-specific accounts
model Person {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?
  phone     String?
  address   String?
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("persons")
}

// Voucher Types
model VoucherType {
  id        Int      @id @default(autoincrement())
  name      String // RV, PV, CV, JV, etc.
  code      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("voucher_types")
}

// Vouchers (Main transaction records)
model Voucher {
  id              Int                  @id @default(autoincrement())
  voucherNo       Int                  @map("voucher_no")
  type            Int // 1-7 (Receipt, Payment, Purchase, Sales, Contra, Journal, Extended JV)
  date            DateTime
  name            String?
  totalAmount     Float                @map("total_amount")
  isApproved      Boolean              @default(false) @map("is_approved")
  isPostDated     Int                  @default(0) @map("is_post_dated") // 0=cleared, 1=post-dated, 2=cancelled
  chequeNo        String?              @map("cheque_no")
  chequeDate      DateTime?            @map("cheque_date")
  purchaseOrderId String?              @map("purchase_order_id")
  isAuto          Boolean              @default(false) @map("is_auto") // Auto-generated from PO/Invoice
  userId          String               @map("user_id")
  generatedAt     DateTime             @default(now()) @map("generated_at")
  clearedDate     DateTime?            @map("cleared_date")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  deletedAt       DateTime?            @map("deleted_at") // Soft delete
  purchaseOrder   PurchaseOrder?       @relation("PurchaseOrderVouchers", fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  transactions    VoucherTransaction[]

  @@index([userId])
  @@index([type])
  @@index([date])
  @@index([isApproved])
  @@index([isPostDated])
  @@index([purchaseOrderId])
  @@map("vouchers")
}

// Voucher Transactions (Double-entry accounting records)
model VoucherTransaction {
  id           Int        @id @default(autoincrement())
  voucherId    Int        @map("voucher_id")
  coaAccountId Int        @map("coa_account_id")
  debit        Float      @default(0)
  credit       Float      @default(0)
  balance      Float // Running balance for the account
  description  String?
  date         DateTime
  userId       String     @map("user_id")
  isApproved   Boolean    @default(false) @map("is_approved")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  deletedAt    DateTime?  @map("deleted_at") // Soft delete
  voucher      Voucher    @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  coaAccount   CoaAccount @relation(fields: [coaAccountId], references: [id], onDelete: Cascade)

  @@index([voucherId])
  @@index([coaAccountId])
  @@index([userId])
  @@index([date])
  @@index([isApproved])
  @@map("voucher_transactions")
}

model PurchaseOrderDeletionLog {
  id              String   @id @default(cuid())
  purchaseOrderId String
  poNo            String
  type            String // "purchase" or "direct"
  deletedBy       String // User ID
  deletedByName   String // User name
  deletedByEmail  String // User email
  deletedByRole   String // User role
  ipAddress       String? // IP address from where deletion occurred
  status          String // Status of PO when deleted
  wasReceived     Boolean  @default(false) // Whether PO was received (stock needs reversal)
  stockReversed   Boolean  @default(false) // Whether stock was successfully reversed
  notes           String? // Additional notes
  createdAt       DateTime @default(now())

  @@index([purchaseOrderId])
  @@index([poNo])
  @@index([deletedBy])
  @@index([createdAt])
}
